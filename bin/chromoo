#!/usr/bin/python3

from chromoo import __version__
from chromoo import ChromooProblem, AlgorithmFactory, ConfigHandler, ChromooCallback
from chromoo.utils import plotter
from chromoo.log import Logger
from chromoo.simulation import loadh5

from chromoo.cache import Cache
from chromoo.simulation import run_sim

from pymoo.util.termination.default import MultiObjectiveDefaultTermination

import numpy as np
import argparse

def main():
    ap = argparse.ArgumentParser()
    ap.add_argument("file", nargs=1, help="yaml config file")
    args = vars(ap.parse_args())

    logger = Logger()
    logger.info("Starting chromoo")
    logger.note('chromoo version', __version__)

    config = ConfigHandler()
    config.read(args['file'][0])
    config.load()
    config.construct_simulation()

    cache = Cache(config.parameters, config.objectives, config.simulation)

    algo = AlgorithmFactory(config.algorithm).get_algorithm()
    prob = ChromooProblem(config.simulation, config.parameters, config.objectives, nproc=config.nproc, store_temp=config.store_temp)

    term = MultiObjectiveDefaultTermination(
        x_tol       = config.termination.x_tol,
        cv_tol      = config.termination.cv_tol,
        f_tol       = config.termination.f_tol,
        nth_gen     = config.termination.nth_gen,
        n_last      = config.termination.n_last,
        n_max_gen   = config.termination.n_max_gen,
        n_max_evals = config.termination.n_max_evals
    )

    algo.setup(prob, term, callback=ChromooCallback(cache), seed=1, verbose=True)

    while algo.has_next():
        algo.next()
        np.save("checkpoint", algo)

    res = algo.result()

    logger.info(f"Took {res.exec_time:.2f} seconds to terminate.")
    logger.info(f"Fitted Parameters: {res.X}")
    logger.info(f"SSE: {res.F}")

    # For single objective systems we get one fixed point
    # For multiobjective systems, we get a set of solutions, a pareto front.
    if len(config.objectives) == 1: 
        run_sim(res.X, config.simulation, config.parameters, name='final.h5', store=True)
        sim = loadh5('final.h5')
        plotter(sim, config.objectives) 
    else:
        for i,x in enumerate(res.X): #type: ignore
            run_sim(x, config.simulation, config.parameters, name=f'final_{i:03d}.h5', store=True)
            sim = loadh5(f'final_{i:03d}.h5')
            plotter(sim, config.objectives) 

    if not config.store_temp:
        import shutil
        shutil.rmtree(prob.tempdir)

    logger.info("Done :)")

if __name__ == "__main__":
    main()
